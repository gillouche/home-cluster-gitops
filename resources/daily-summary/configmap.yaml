apiVersion: v1
kind: ConfigMap
metadata:
  name: daily-summary-script
  namespace: monitoring
data:
  summary.py: |
    import os
    import json
    import urllib.request
    import urllib.parse
    from datetime import datetime

    WEBHOOK_URL = os.environ.get("DISCORD_WEBHOOK_URL")
    PROMETHEUS_URL = "http://monitoring-kube-prometheus-prometheus.monitoring.svc:9090"

    def query_prometheus(query):
        params = urllib.parse.urlencode({'query': query})
        url = f"{PROMETHEUS_URL}/api/v1/query?{params}"
        try:
            with urllib.request.urlopen(url) as response:
                data = json.loads(response.read().decode())
                if data['status'] == 'success' and data['data']['result']:
                    return data['data']['result'][0]['value'][1]
        except Exception as e:
            print(f"Error querying {query}: {e}")
        return "N/A"

    def format_bytes(size):
        try:
            size = float(size)
            power = 2**10
            n = 0
            power_labels = {0 : 'B', 1: 'KiB', 2: 'MiB', 3: 'GiB', 4: 'TiB'}
            while size > power:
                size /= power
                n += 1
            return f"{size:.2f} {power_labels.get(n, '?')}"
        except:
            return size

    def main():
        if not WEBHOOK_URL:
            print("No webhook URL provided")
            # Don't fail, just exit
            return

        # Queries
        # CPU: Avg usage across all nodes (approximate)
        cpu_usage = query_prometheus('100 - (avg by (instance) (rate(node_cpu_seconds_total{mode="idle"}[5m])) * 100)')
        
        # Memory
        mem_usage = query_prometheus('sum(node_memory_MemTotal_bytes) - sum(node_memory_MemAvailable_bytes)')
        mem_total = query_prometheus('sum(node_memory_MemTotal_bytes)')
        
        # Status
        nodes_up = query_prometheus('count(kube_node_status_condition{condition="Ready", status="true"})')
        pods_running = query_prometheus('count(kube_pod_status_phase{phase="Running"})')
        
        # Storage
        pvc_usage = query_prometheus('sum(kubelet_volume_stats_used_bytes)')

        # Formatting
        try:
            cpu_text = f"{float(cpu_usage):.1f}%"
        except: cpu_text = "N/A"

        try:
            mem_percent = (float(mem_usage) / float(mem_total)) * 100
            mem_text = f"{format_bytes(mem_usage)} / {format_bytes(mem_total)} ({mem_percent:.1f}%)"
        except: mem_text = "N/A"

        embed = {
            "title": f"Daily Cluster Summary - {datetime.now().strftime('%Y-%m-%d')}",
            "color": 3066993, # Green/Blue
            "fields": [
                {"name": "Nodes Ready", "value": str(nodes_up), "inline": True},
                {"name": "Pods Running", "value": str(pods_running), "inline": True},
                {"name": "CPU Usage (Avg)", "value": cpu_text, "inline": True},
                {"name": "Memory Usage", "value": mem_text, "inline": True},
                {"name": "Storage Used", "value": format_bytes(pvc_usage), "inline": True}
            ],
            "footer": {"text": "Sent via Gemini GitOps Agent"}
        }

        payload = {"embeds": [embed]}
        
        # Determine URL: handle file or string
        # If env var points to file (e.g. from secret mount), read it
        url = WEBHOOK_URL
        if os.path.isfile(url):
            with open(url, 'r') as f:
                url = f.read().strip()

        req = urllib.request.Request(url, data=json.dumps(payload).encode(), headers={'Content-Type': 'application/json', 'User-Agent': 'DailySummaryBot'})
        try:
            urllib.request.urlopen(req)
            print("Summary sent successfully")
        except Exception as e:
            print(f"Error sending to Discord: {e}")

    if __name__ == "__main__":
        main()

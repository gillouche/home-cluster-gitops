apiVersion: monitoring.coreos.com/v1alpha1
kind: AlertmanagerConfig
metadata:
  name: discord-config
  namespace: monitoring
  labels:
    alertmanagerConfig: discord
spec:
  route:
    groupBy: ['alertname', 'job']
    groupWait: 1s
    groupInterval: 1m
    repeatInterval: 5m
    receiver: 'discord-firing' # Default Fallback for anything not matched
    routes:
      - matchers:
          - name: alertname
            value: Watchdog
        receiver: 'discord-heartbeat'
        repeatInterval: 5m

      
      # -- Critical Infrastructure --
      - matchers:
          - name: alertname
            regex: true
            value: ^(TargetDown|NodeSystemSaturation|NodeHighCPU|InstanceDown|KubeNodeNotReady|NodeOOMKillDetected)$
        receiver: 'discord-critical'

      # -- Storage (Longhorn) --
      # Explicitly catch storage alerts first to avoid duplicates in Critical/Warning
      - matchers:
          - name: alertname
            regex: true
            value: ^(Longhorn.*|Volume.*)$
        receiver: 'discord-storage'

      # -- Network --
      # Explicitly catch network alerts first
      - matchers:
          - name: alertname
            regex: true
            value: ^(Probe.*|Net.*|Network.*)$
        receiver: 'discord-network'
      - matchers:
          - name: job
            value: blackbox
        receiver: 'discord-network'

      # -- Renovate --
      - matchers:
          - name: job
            regex: true
            value: .*renovate.*
        receiver: 'discord-info'
    
      # -- Pod Events --
      - matchers:
          - name: category
            value: pod-events
        receiver: 'discord-pods'
        continue: true

      # -- Critical Severity (General Catch-all) --
      - matchers:
          - name: severity
            value: critical
        receiver: 'discord-critical'
        continue: true

      # -- Warnings (General Catch-all) --
      - matchers:
          - name: severity
            value: warning
        receiver: 'discord-warning'
        continue: true
      
      # -- Info --
      - matchers:
          - name: severity
            value: info
        receiver: 'discord-info'

  receivers:
  - name: 'null'
  - name: 'discord-firing'
    discordConfigs:
    - apiURL:
        key: prometheus-firing
        name: monitoring-discord-webhooks
      sendResolved: true
      title: '{{ if eq .Status "firing" }}üîî ALERT{{ else }}‚úÖ RESOLVED{{ end }}: {{ .GroupLabels.alertname }}'
      message: |-
        {{ range .Alerts }}
        {{ if ne .Labels.alertname "Watchdog" }}
        ‚Ä¢ **{{ .Annotations.summary }}**
          {{ .Annotations.description }}
          *Node: {{ if .Labels.node }}{{ .Labels.node }}{{ end }}{{ if and .Labels.node .Labels.instance }} ({{ .Labels.instance | reReplaceAll ":\\d+$" "" }}){{ else if .Labels.instance }} ({{ .Labels.instance | reReplaceAll ":\\d+$" "" }}){{ else }}N/A{{ end }}*
          *Time: {{ .StartsAt.Format "2006-01-02T15:04:05Z07:00" }}*{{ end }}
        {{ end }}

  - name: 'discord-critical'
    discordConfigs:
    - apiURL:
        key: critical-alerts
        name: monitoring-discord-webhooks
      sendResolved: true
      title: '{{ if eq .Status "firing" }}üî• CRITICAL{{ else }}‚úÖ RESOLVED{{ end }}: {{ .GroupLabels.alertname }}'
      message: |-
        {{ range .Alerts }}
        {{ if ne .Labels.alertname "Watchdog" }}
        ‚Ä¢ **{{ .Annotations.summary }}**
          {{ .Annotations.description }}
          *Node: {{ if .Labels.node }}{{ .Labels.node }}{{ end }}{{ if and .Labels.node .Labels.instance }} ({{ .Labels.instance | reReplaceAll ":\\d+$" "" }}){{ else if .Labels.instance }} ({{ .Labels.instance | reReplaceAll ":\\d+$" "" }}){{ else }}N/A{{ end }}*
          *Time: {{ .StartsAt.Format "2006-01-02T15:04:05Z07:00" }}*{{ end }}
        {{ end }}

  - name: 'discord-warning'
    discordConfigs:
    - apiURL:
        key: warning-alerts
        name: monitoring-discord-webhooks
      sendResolved: true
      title: '{{ if eq .Status "firing" }}‚ö†Ô∏è WARNING{{ else }}‚úÖ RESOLVED{{ end }}: {{ .GroupLabels.alertname }}'
      message: |-
        {{ range .Alerts }}
        {{ if ne .Labels.alertname "Watchdog" }}
        ‚Ä¢ **{{ .Annotations.summary }}**
          {{ .Annotations.description }}
          *Node: {{ if .Labels.node }}{{ .Labels.node }}{{ end }}{{ if and .Labels.node .Labels.instance }} ({{ .Labels.instance | reReplaceAll ":\\d+$" "" }}){{ else if .Labels.instance }} ({{ .Labels.instance | reReplaceAll ":\\d+$" "" }}){{ else }}N/A{{ end }}*
          *Time: {{ .StartsAt.Format "2006-01-02T15:04:05Z07:00" }}*{{ end }}
        {{ end }}

  - name: 'discord-info'
    discordConfigs:
    - apiURL:
        key: info-alerts
        name: monitoring-discord-webhooks
      sendResolved: true
      title: '{{ if eq .Status "firing" }}‚ÑπÔ∏è INFO{{ else }}‚úÖ RESOLVED{{ end }}: {{ .GroupLabels.alertname }}'
      message: |-
        {{ range .Alerts }}
        {{ if ne .Labels.alertname "Watchdog" }}
        ‚Ä¢ **{{ .Annotations.summary }}**
          {{ .Annotations.description }}
          *Node: {{ if .Labels.node }}{{ .Labels.node }}{{ end }}{{ if and .Labels.node .Labels.instance }} ({{ .Labels.instance | reReplaceAll ":\\d+$" "" }}){{ else if .Labels.instance }} ({{ .Labels.instance | reReplaceAll ":\\d+$" "" }}){{ else }}N/A{{ end }}*
          *Time: {{ .StartsAt.Format "2006-01-02T15:04:05Z07:00" }}*{{ end }}
        {{ end }}

  - name: 'discord-network'
    discordConfigs:
    - apiURL:
        key: network-issues
        name: monitoring-discord-webhooks
      sendResolved: true
      title: '{{ if eq .Status "firing" }}üåê NETWORK{{ else }}‚úÖ RESOLVED{{ end }}: {{ .GroupLabels.alertname }}'
      message: |-
        {{ range .Alerts }}
        {{ if ne .Labels.alertname "Watchdog" }}
        ‚Ä¢ **{{ .Annotations.summary }}**
          {{ .Annotations.description }}
          *Node: {{ if .Labels.node }}{{ .Labels.node }}{{ end }}{{ if and .Labels.node .Labels.instance }} ({{ .Labels.instance | reReplaceAll ":\\d+$" "" }}){{ else if .Labels.instance }} ({{ .Labels.instance | reReplaceAll ":\\d+$" "" }}){{ else }}N/A{{ end }}*
          *Time: {{ .StartsAt.Format "2006-01-02T15:04:05Z07:00" }}*{{ end }}
        {{ end }}

  - name: 'discord-storage'
    discordConfigs:
    - apiURL:
        key: storage-issues
        name: monitoring-discord-webhooks
      sendResolved: true
      title: '{{ if eq .Status "firing" }}üíæ STORAGE{{ else }}‚úÖ RESOLVED{{ end }}: {{ .GroupLabels.alertname }}'
      message: |-
        {{ range .Alerts }}
        {{ if ne .Labels.alertname "Watchdog" }}
        ‚Ä¢ **{{ .Annotations.summary }}**
          {{ .Annotations.description }}
          *Node: {{ if .Labels.node }}{{ .Labels.node }}{{ end }}{{ if and .Labels.node .Labels.instance }} ({{ .Labels.instance | reReplaceAll ":\\d+$" "" }}){{ else if .Labels.instance }} ({{ .Labels.instance | reReplaceAll ":\\d+$" "" }}){{ else }}N/A{{ end }}*
          *Time: {{ .StartsAt.Format "2006-01-02T15:04:05Z07:00" }}*{{ end }}
        {{ end }}

  - name: 'discord-heartbeat'
    discordConfigs:
    - apiURL:
        key: prometheus-firing
        name: monitoring-discord-webhooks
      sendResolved: true
      title: '{{ if eq .Status "firing" }}üíì HEARTBEAT{{ else }}‚úÖ RESOLVED{{ end }}: {{ .GroupLabels.alertname }}'
      message: |-
        {{ range .Alerts }}
        ‚Ä¢ **{{ .Annotations.summary }}**
          {{ .Annotations.description }}
          *Node: {{ if .Labels.node }}{{ .Labels.node }}{{ end }}{{ if and .Labels.node .Labels.instance }} ({{ .Labels.instance | reReplaceAll ":\\d+$" "" }}){{ else if .Labels.instance }} ({{ .Labels.instance | reReplaceAll ":\\d+$" "" }}){{ else }}N/A{{ end }}*
          *Time: {{ .StartsAt.Format "2006-01-02T15:04:05Z07:00" }}*
        {{ end }}


  - name: 'discord-pods'
    discordConfigs:
    - apiURL:
        key: pod-events
        name: monitoring-discord-webhooks
      sendResolved: true
      title: '{{ if eq .Status "firing" }}üì¶ POD{{ else }}‚úÖ RESOLVED{{ end }}: {{ .GroupLabels.alertname }}'
      message: |-
        {{ range .Alerts }}
        {{ if ne .Labels.alertname "Watchdog" }}
        ‚Ä¢ **{{ .Annotations.summary }}**
          {{ .Annotations.description }}
          *Node: {{ if .Labels.node }}{{ .Labels.node }}{{ end }}{{ if and .Labels.node .Labels.instance }} ({{ .Labels.instance | reReplaceAll ":\\d+$" "" }}){{ else if .Labels.instance }} ({{ .Labels.instance | reReplaceAll ":\\d+$" "" }}){{ else }}N/A{{ end }}*
          *Time: {{ .StartsAt.Format "2006-01-02T15:04:05Z07:00" }}*{{ end }}
        {{ end }}

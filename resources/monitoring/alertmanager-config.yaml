apiVersion: monitoring.coreos.com/v1alpha1
kind: AlertmanagerConfig
metadata:
  name: discord-config
  namespace: monitoring
  labels:
    alertmanagerConfig: discord
spec:
  route:
    groupBy: ['alertname', 'job']
    groupWait: 30s
    groupInterval: 5m
    repeatInterval: 3h
    receiver: 'discord-firing' # Default Fallback
    routes:
      - matchers:
          - name: alertname
            value: Watchdog
        receiver: 'null'
      
      # -- Critical (RPi Freeze Risks) --
      - matchers:
          - name: severity
            value: critical
        receiver: 'discord-critical'
        continue: true

      # -- Storage (Longhorn) --
      - matchers:
          - name: alertname
            regex: true
            value: ^(Longhorn.*|Volume.*)$
        receiver: 'discord-storage'
        continue: true

      # -- Network (Blackbox) --
      - matchers:
          - name: job
            value: blackbox
        receiver: 'discord-network'
        continue: true
      - matchers:
          - name: alertname
            regex: true
            value: ^(Probe.*)$
        receiver: 'discord-network'
        continue: true

      # -- Cluster Health (Nodes/Kubelet) --
      - matchers:
          - name: alertname
            regex: true
            value: ^(KubeNode.*|Kubelet.*|InstanceDown)$
        receiver: 'discord-health'
        continue: true

      # -- Pod Events --
      - matchers:
          - name: category
            value: pod-events
        receiver: 'discord-pods'
        continue: true

      # -- Warnings (General) --
      - matchers:
          - name: severity
            value: warning
        receiver: 'discord-warning'
        continue: true
      
      # -- Info --
      - matchers:
          - name: severity
            value: info
        receiver: 'discord-info'

  receivers:
  - name: 'null'
  - name: 'discord-firing'
    discordConfigs:
    - apiURL:
        key: prometheus-firing
        name: monitoring-discord-webhooks
      sendResolved: true
      title: '{{ if eq .Status "firing" }}üîî ALERT{{ else }}‚úÖ RESOLVED{{ end }}: {{ .GroupLabels.alertname }}'
      message: |-
        {{ range .Alerts }}
        ‚Ä¢ **{{ .Annotations.summary }}**
          {{ .Annotations.description }}
          *Node: {{ or .Labels.node .Labels.nodename .Labels.instance "N/A" }}*
        {{ end }}

  - name: 'discord-critical'
    discordConfigs:
    - apiURL:
        key: critical-alerts
        name: monitoring-discord-webhooks
      sendResolved: true
      title: '{{ if eq .Status "firing" }}üî• CRITICAL{{ else }}‚úÖ RESOLVED{{ end }}: {{ .GroupLabels.alertname }}'
      message: |-
        {{ range .Alerts }}
        ‚Ä¢ **{{ .Annotations.summary }}**
          {{ .Annotations.description }}
          *Node: {{ or .Labels.node .Labels.nodename .Labels.instance "N/A" }}*
        {{ end }}

  - name: 'discord-warning'
    discordConfigs:
    - apiURL:
        key: warning-alerts
        name: monitoring-discord-webhooks
      sendResolved: true
      title: '{{ if eq .Status "firing" }}‚ö†Ô∏è WARNING{{ else }}‚úÖ RESOLVED{{ end }}: {{ .GroupLabels.alertname }}'
      message: |-
        {{ range .Alerts }}
        ‚Ä¢ **{{ .Annotations.summary }}**
          {{ .Annotations.description }}
          *Node: {{ or .Labels.node .Labels.nodename .Labels.instance "N/A" }}*
        {{ end }}

  - name: 'discord-info'
    discordConfigs:
    - apiURL:
        key: info-alerts
        name: monitoring-discord-webhooks
      sendResolved: true
      title: '{{ if eq .Status "firing" }}‚ÑπÔ∏è INFO{{ else }}‚úÖ RESOLVED{{ end }}: {{ .GroupLabels.alertname }}'
      message: |-
        {{ range .Alerts }}
        ‚Ä¢ **{{ .Annotations.summary }}**
          {{ .Annotations.description }}
          *Node: {{ or .Labels.node .Labels.nodename .Labels.instance "N/A" }}*
        {{ end }}

  - name: 'discord-network'
    discordConfigs:
    - apiURL:
        key: network-issues
        name: monitoring-discord-webhooks
      sendResolved: true
      title: '{{ if eq .Status "firing" }}üåê NETWORK{{ else }}‚úÖ RESOLVED{{ end }}: {{ .GroupLabels.alertname }}'
      message: |-
        {{ range .Alerts }}
        ‚Ä¢ **{{ .Annotations.summary }}**
          {{ .Annotations.description }}
          *Node: {{ or .Labels.node .Labels.nodename .Labels.instance "N/A" }}*
        {{ end }}

  - name: 'discord-storage'
    discordConfigs:
    - apiURL:
        key: storage-issues
        name: monitoring-discord-webhooks
      sendResolved: true
      title: '{{ if eq .Status "firing" }}üíæ STORAGE{{ else }}‚úÖ RESOLVED{{ end }}: {{ .GroupLabels.alertname }}'
      message: |-
        {{ range .Alerts }}
        ‚Ä¢ **{{ .Annotations.summary }}**
          {{ .Annotations.description }}
          *Node: {{ or .Labels.node .Labels.nodename .Labels.instance "N/A" }}*
        {{ end }}

  - name: 'discord-health'
    discordConfigs:
    - apiURL:
        key: cluster-health
        name: monitoring-discord-webhooks
      sendResolved: true
      title: '{{ if eq .Status "firing" }}üè• HEALTH{{ else }}‚úÖ RESOLVED{{ end }}: {{ .GroupLabels.alertname }}'
      message: |-
        {{ range .Alerts }}
        ‚Ä¢ **{{ .Annotations.summary }}**
          {{ .Annotations.description }}
          *Node: {{ or .Labels.node .Labels.nodename .Labels.instance "N/A" }}*
        {{ end }}

  - name: 'discord-pods'
    discordConfigs:
    - apiURL:
        key: pod-events
        name: monitoring-discord-webhooks
      sendResolved: true
      title: '{{ if eq .Status "firing" }}üì¶ POD{{ else }}‚úÖ RESOLVED{{ end }}: {{ .GroupLabels.alertname }}'
      message: |-
        {{ range .Alerts }}
        ‚Ä¢ **{{ .Annotations.summary }}**
          {{ .Annotations.description }}
          *Node: {{ or .Labels.node .Labels.nodename .Labels.instance "N/A" }}*
        {{ end }}

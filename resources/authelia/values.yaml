image:
  repository: authelia/authelia
  tag: "4.39.15"


pod:
  replicas: 2
  kind: Deployment

  selectors:
    # Ensure High Availability by spreading pods across different nodes
    affinity:
      nodeAffinity:
        requiredDuringSchedulingIgnoredDuringExecution:
          nodeSelectorTerms:
            - matchExpressions:
                - key: node-class
                  operator: In
                  values: ["homeserver"]
      podAntiAffinity:
        requiredDuringSchedulingIgnoredDuringExecution:
          - labelSelector:
              matchExpressions:
                - key: app.kubernetes.io/name
                  operator: In
                  values:
                    - authelia
            topologyKey: "kubernetes.io/hostname"  

  env:
    - name: AUTHELIA_IDENTITY_VALIDATION_RESET_PASSWORD_JWT_SECRET_FILE
      value: /secrets/authelia-secrets/jwt_secret
    - name: AUTHELIA_SESSION_SECRET_FILE
      value: /secrets/authelia-secrets/session_secret
    - name: AUTHELIA_STORAGE_ENCRYPTION_KEY_FILE
      value: /secrets/authelia-secrets/storage_encryption_key
    - name: AUTHELIA_SESSION_REDIS_PASSWORD_FILE
      value: /secrets/authelia-secrets/session_secret
    - name: AUTHELIA_STORAGE_POSTGRES_PASSWORD_FILE
      value: /secrets/authelia-secrets/postgres_password
  
  securityContext:
    pod:
      fsGroup: 1000
      runAsUser: 1000
      runAsGroup: 1000
    container:
      runAsUser: 1000
      runAsGroup: 1000
  
  # Custom volumes for user database and OIDC client secrets
  # Note: OIDC client secrets are NOT auto-mounted by the chart, must be added manually
  extraVolumes:
    - name: user-database
      secret:
        secretName: authelia-secrets
        items:
          - key: users_database.yml
            path: users_database.yml
    - name: oidc-secrets
      secret:
        secretName: authelia-secrets
        items:
          - key: argocd_client_secret
            path: argocd_client_secret
          - key: grafana_client_secret
            path: grafana_client_secret
          - key: oidc_jwks_key
            path: oidc_jwks_key

  extraVolumeMounts:
    - name: user-database
      mountPath: /config/users_database.yml
      subPath: users_database.yml
      readOnly: true
    - name: oidc-secrets
      mountPath: /secrets/oidc
      readOnly: true

persistence:
  enabled: false
  size: 1Gi
  accessModes:
    - ReadWriteOnce

secret:
  # Enable native secret mounting
  existingSecret: authelia-secrets
  additionalSecrets:
    authelia-secrets:
      items:
        - key: jwt_secret
          path: jwt_secret
        - key: session_secret
          path: session_secret
        - key: session_secret
          path: session_secret
        - key: storage_encryption_key
          path: storage_encryption_key
        - key: postgres_password
          path: postgres_password

configMap:
  # Use custom ConfigMap for actual Authelia configuration
  existingConfigMap: authelia-config

  identity_validation:
    reset_password:
      secret:
        disabled: true

  # These values are used by the chart for validation and stateful check
  # The actual config comes from authelia-config ConfigMap which uses file-based auth
  authentication_backend:
    file:
      enabled: false
    ldap:
      enabled: true  # Fake LDAP to bypass HA restriction (actual config uses file auth)
      password:
        disabled: true

  session:
    encryption_key:
      disabled: true
    cookies:
      - domain: k3s.gillouche.homelab
        subdomain: auth
    redis:
      enabled: true
      password:
        disabled: true

  storage:
    encryption_key:
      disabled: true
    postgres:
      enabled: true
      password:
        disabled: true

  notifier:
    smtp:
      password:
        disabled: true

ingress:
  enabled: true
  className: traefik
  annotations:
    traefik.ingress.kubernetes.io/router.entrypoints: web
  # Simplifed rulesOverride structure as per chart template
  rulesOverride:
    - host: auth.k3s.gillouche.homelab
      path: /


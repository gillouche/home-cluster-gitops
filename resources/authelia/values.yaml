image:
  repository: authelia/authelia
  tag: "4.39.13"


pod:
  replicas: 2
  kind: Deployment

  selectors:
    # Ensure High Availability by spreading pods across different nodes
    affinity:
      podAntiAffinity:
        requiredDuringSchedulingIgnoredDuringExecution:
          - labelSelector:
              matchExpressions:
                - key: app.kubernetes.io/name
                  operator: In
                  values:
                    - authelia
            topologyKey: "kubernetes.io/hostname"  

  
  securityContext:
    pod:
      fsGroup: 1000
      runAsUser: 1000
      runAsGroup: 1000
    container:
      runAsUser: 1000
      runAsGroup: 1000
  
  # Only custom volumes here (database). Secrets are handled by 'secret' block below.
  extraVolumes:
    - name: user-database
      secret:
        secretName: authelia-secrets
        items:
          - key: users_database.yml
            path: users_database.yml

  extraVolumeMounts:
    - name: user-database
      mountPath: /config/users_database.yml
      subPath: users_database.yml
      readOnly: true

persistence:
  enabled: false
  size: 1Gi
  accessModes:
    - ReadWriteOnce

secret:
  # Enable native secret mounting
  existingSecret: authelia-secrets

configMap:
  # Explicitly set server path to empty string (root) to match Ingress
  server:
    path: "/"

  authentication_backend:
    file:
      path: /config/users_database.yml
      watch: true

  access_control:
    default_policy: deny
    rules:
      - domain: "auth.k3s.gillouche.homelab"
        policy: bypass
      - domain: "*.k3s.gillouche.homelab"
        policy: one_factor

  session:
    # Required for Ingress validation and App logic
    encryption_key:
      path: /secrets/internal/session_secret
    cookies:
      - domain: k3s.gillouche.homelab
        subdomain: auth
    redis:
      host: authelia-redis-master
      port: 6379
      password:
        path: /secrets/internal/session_secret
        disabled: false
  
  storage:
    encryption_key:
      # Relative path within /secrets provided by 'secret' block
      path: storage_encryption_key
    postgres:
      enabled: true
      address: 'tcp://192.168.0.247:15432'
      database: authelia
      username: authelia
      password:
        path: postgres_password
    local:
      enabled: false
      path: /config/db.sqlite3

  notifier:
    filesystem:
      enabled: true
      filename: /tmp/emails.txt

  identity_validation:
    reset_password:
      jwt_lifespan: '5 minutes'
      jwt_algorithm: 'HS256'
      secret:
        # Relative path within /secrets provided by 'secret' block
        path: jwt_secret
        disabled: false

  identity_providers:
    oidc:
      enabled: true
      hmac_secret:
        path: session_secret
      clients:
        - client_name: ArgoCD
          client_id: argocd
          client_secret:
            path: /secrets/internal/argocd_client_secret
          public: false
          authorization_policy: one_factor
          redirect_uris:
            - https://argocd.k3s.gillouche.homelab/auth/callback
          scopes:
            - openid
            - groups
            - profile
            - email

        - client_name: Grafana
          client_id: grafana
          client_secret:
            path: /secrets/internal/grafana_client_secret
          public: false
          authorization_policy: one_factor
          redirect_uris:
            - https://grafana.k3s.gillouche.homelab/login/generic_oauth
          scopes:
            - openid
            - groups
            - profile
            - email

ingress:
  enabled: true
  className: traefik
  annotations:
    traefik.ingress.kubernetes.io/router.entrypoints: web, websecure
  # Simplifed rulesOverride structure as per chart template
  rulesOverride:
    - host: auth.k3s.gillouche.homelab
      path: /

redis:
  enabled: true
  auth:
    enabled: true
    existingSecret: authelia-secrets
    existingSecretPasswordKey: session_secret
  architecture: standalone
  master:
    persistence:
      enabled: false

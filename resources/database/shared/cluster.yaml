apiVersion: postgresql.cnpg.io/v1
kind: Cluster
metadata:
  name: shared-db
  namespace: database
spec:
  enableSuperuserAccess: true
  superuserSecret:
    name: shared-db-superuser
  instances: 3
  
  # Image Configuration
  imageName: ghcr.io/cloudnative-pg/postgresql:16.1
  
  # Storage Configuration
  storage:
    size: 50Gi
    storageClass: longhorn
    resizeInUseVolumes: true
  
  # Monitoring
  monitoring:
    enablePodMonitor: false
    # customQueriesConfigMap:
    #   - name: cnpg-default-monitoring
    #     key: queries

  # Bootstrap Method (InitDB)
  bootstrap:
    initdb:
      database: sonarqube
      owner: sonarqube
      
  # Managed Roles (Users)
  managed:
    roles:
    - name: sonarqube
      ensure: present
      login: true
      connectionLimit: -1
      inherit: true
      passwordSecret:
        name: shared-db-sonarqube
    - name: polaris
      ensure: present
      login: true
      connectionLimit: -1
      inherit: true
      passwordSecret:
        name: polaris-secrets
    - name: attic
      ensure: present
      login: true
      connectionLimit: -1
      inherit: true
      passwordSecret:
        name: attic-secrets
  
  inheritedMetadata:
    annotations:
      reflector.v1.k8s.emberstack.com/reflection-allowed: "true"
      reflector.v1.k8s.emberstack.com/reflection-auto-enabled: "true"
      reflector.v1.k8s.emberstack.com/reflection-allowed-namespaces: "sonarqube,data-lake,attic"

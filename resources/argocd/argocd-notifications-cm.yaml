apiVersion: v1
kind: ConfigMap
metadata:
  name: argocd-notifications-cm
  namespace: argocd
  labels:
    app.kubernetes.io/name: argocd-notifications-controller
    app.kubernetes.io/part-of: argocd
data:
  service.webhook.discord-infra: |
    url: $argocd-infra
    headers:
      - name: Content-Type
        value: application/json

  service.webhook.discord-playground: |
    url: $argocd-playground
    headers:
      - name: Content-Type
        value: application/json

  template.app-sync-succeeded: |
    webhook:
      discord-infra:
        method: POST
        body: |
          {
            "embeds": [
              {
                "title": "‚úÖ Application {{ .app.metadata.name }} Synced",
                "description": "Synced successfully at `{{ .app.status.operationState.finishedAt }}`",
                "color": 3066993,
                "fields": [
                  {"name": "Namespace", "value": "{{ .app.metadata.namespace }}", "inline": true},
                  {"name": "Revision", "value": "{{ .app.status.sync.revision }}", "inline": true},
                  {"name": "Health", "value": "{{ .app.status.health.status }}", "inline": true},
                  {"name": "Status", "value": "{{ .app.status.operationState.phase }}", "inline": true}
                ],
                "footer": {"text": "ArgoCD Notifications"}
              }
            ]
          }
      discord-playground:
        method: POST
        body: |
          {
            "embeds": [
              {
                "title": "‚úÖ Application {{ .app.metadata.name }} Synced",
                "description": "Synced successfully at `{{ .app.status.operationState.finishedAt }}`",
                "color": 3066993,
                "fields": [
                  {"name": "Namespace", "value": "{{ .app.metadata.namespace }}", "inline": true},
                  {"name": "Revision", "value": "{{ .app.status.sync.revision }}", "inline": true},
                  {"name": "Health", "value": "{{ .app.status.health.status }}", "inline": true},
                  {"name": "Status", "value": "{{ .app.status.operationState.phase }}", "inline": true}
                ],
                "footer": {"text": "ArgoCD Notifications"}
              }
            ]
          }

  template.app-sync-failed: |
    webhook:
      discord-infra:
        method: POST
        body: |
          {
            "embeds": [
              {
                "title": "‚ùå Application {{ .app.metadata.name }} Sync Failed",
                "description": "Error: `{{ .app.status.operationState.message }}`",
                "color": 15158332,
                "fields": [
                  {"name": "Namespace", "value": "{{ .app.metadata.namespace }}", "inline": true},
                  {"name": "Revision", "value": "{{ .app.status.sync.revision }}", "inline": true},
                  {"name": "Health", "value": "{{ .app.status.health.status }}", "inline": true},
                  {"name": "Status", "value": "{{ .app.status.operationState.phase }}", "inline": true}
                ],
                "footer": {"text": "ArgoCD Notifications"}
              }
            ]
          }
      discord-playground:
        method: POST
        body: |
          {
            "embeds": [
              {
                "title": "‚ùå Application {{ .app.metadata.name }} Sync Failed",
                "description": "Error: `{{ .app.status.operationState.message }}`",
                "color": 15158332,
                "fields": [
                  {"name": "Namespace", "value": "{{ .app.metadata.namespace }}", "inline": true},
                  {"name": "Revision", "value": "{{ .app.status.sync.revision }}", "inline": true},
                  {"name": "Health", "value": "{{ .app.status.health.status }}", "inline": true},
                  {"name": "Status", "value": "{{ .app.status.operationState.phase }}", "inline": true}
                ],
                "footer": {"text": "ArgoCD Notifications"}
              }
            ]
          }

  template.app-health-degraded: |
    webhook:
      discord-infra:
        method: POST
        body: |
          {
            "embeds": [
              {
                "title": "‚ö†Ô∏è Application {{ .app.metadata.name }} Health Degraded",
                "description": "Current status: `{{ .app.status.health.status }}`",
                "color": 15105570,
                "fields": [
                  {"name": "Namespace", "value": "{{ .app.metadata.namespace }}", "inline": true},
                  {"name": "Revision", "value": "{{ .app.status.sync.revision }}", "inline": true},
                  {"name": "Last Sync", "value": "{{ .app.status.operationState.finishedAt }}", "inline": true},
                  {"name": "Status", "value": "{{ .app.status.operationState.phase }}", "inline": true}
                ],
                "footer": {"text": "ArgoCD Notifications"}
              }
            ]
          }
      discord-playground:
        method: POST
        body: |
          {
            "embeds": [
              {
                "title": "‚ö†Ô∏è Application {{ .app.metadata.name }} Health Degraded",
                "description": "Current status: `{{ .app.status.health.status }}`",
                "color": 15105570,
                "fields": [
                  {"name": "Namespace", "value": "{{ .app.metadata.namespace }}", "inline": true},
                  {"name": "Revision", "value": "{{ .app.status.sync.revision }}", "inline": true},
                  {"name": "Last Sync", "value": "{{ .app.status.operationState.finishedAt }}", "inline": true},
                  {"name": "Status", "value": "{{ .app.status.operationState.phase }}", "inline": true}
                ],
                "footer": {"text": "ArgoCD Notifications"}
              }
            ]
          }

  template.app-deployed: |
    webhook:
      discord-infra:
        method: POST
        body: |
          {
            "embeds": [
              {
                "title": "üéâ Application {{ .app.metadata.name }} Deployed",
                "description": "Deployed successfully and healthy at `{{ .app.status.operationState.finishedAt }}`",
                "color": 3066993,
                "fields": [
                  {"name": "Namespace", "value": "{{ .app.metadata.namespace }}", "inline": true},
                  {"name": "Revision", "value": "{{ .app.status.sync.revision }}", "inline": true},
                  {"name": "Health", "value": "{{ .app.status.health.status }}", "inline": true},
                  {"name": "Status", "value": "{{ .app.status.operationState.phase }}", "inline": true}
                ],
                "footer": {"text": "ArgoCD Notifications"}
              }
            ]
          }
      discord-playground:
        method: POST
        body: |
          {
            "embeds": [
              {
                "title": "üéâ Application {{ .app.metadata.name }} Deployed",
                "description": "Deployed successfully and healthy at `{{ .app.status.operationState.finishedAt }}`",
                "color": 3066993,
                "fields": [
                  {"name": "Namespace", "value": "{{ .app.metadata.namespace }}", "inline": true},
                  {"name": "Revision", "value": "{{ .app.status.sync.revision }}", "inline": true},
                  {"name": "Health", "value": "{{ .app.status.health.status }}", "inline": true},
                  {"name": "Status", "value": "{{ .app.status.operationState.phase }}", "inline": true}
                ],
                "footer": {"text": "ArgoCD Notifications"}
              }
            ]
          }

  trigger.on-sync-succeeded-infra: |
    - description: Application sync succeeded (Infra)
      send: [app-sync-succeeded]
      when: app.status.operationState.phase in ['Succeeded'] and app.spec.project matches 'infra-.*'

  trigger.on-sync-failed-infra: |
    - description: Application sync failed (Infra)
      send: [app-sync-failed]
      when: app.status.operationState.phase in ['Failed', 'Error'] and app.spec.project matches 'infra-.*'

  trigger.on-health-degraded-infra: |
    - description: Application health degraded (Infra)
      send: [app-health-degraded]
      when: app.status.health.status in ['Degraded', 'Missing', 'Unknown'] and app.spec.project matches 'infra-.*'

  trigger.on-deployed-infra: |
    - description: Application deployed and healthy (Infra)
      send: [app-deployed]
      when: app.status.operationState.phase == 'Succeeded' and app.status.health.status == 'Healthy' and app.spec.project matches 'infra-.*'
      oncePer: app.status.sync.revision

  trigger.on-sync-succeeded-playground: |
    - description: Application sync succeeded (Playground)
      send: [app-sync-succeeded]
      when: app.status.operationState.phase in ['Succeeded'] and app.spec.project matches 'playground-.*'

  trigger.on-sync-failed-playground: |
    - description: Application sync failed (Playground)
      send: [app-sync-failed]
      when: app.status.operationState.phase in ['Failed', 'Error'] and app.spec.project matches 'playground-.*'

  trigger.on-health-degraded-playground: |
    - description: Application health degraded (Playground)
      send: [app-health-degraded]
      when: app.status.health.status in ['Degraded', 'Missing', 'Unknown'] and app.spec.project matches 'playground-.*'

  trigger.on-deployed-playground: |
    - description: Application deployed and healthy (Playground)
      send: [app-deployed]
      when: app.status.operationState.phase == 'Succeeded' and app.status.health.status == 'Healthy' and app.spec.project matches 'playground-.*'
      oncePer: app.status.sync.revision

  subscriptions: |
    - recipients:
        - discord-infra
      triggers:
        - on-sync-failed-infra
        - on-health-degraded-infra
        - on-deployed-infra
  
    - recipients:
        - discord-playground
      triggers:
        - on-sync-failed-playground
        - on-health-degraded-playground
        - on-deployed-playground

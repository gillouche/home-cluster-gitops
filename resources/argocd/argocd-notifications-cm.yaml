apiVersion: v1
kind: ConfigMap
metadata:
  name: argocd-notifications-cm
  namespace: argocd
  labels:
    app.kubernetes.io/name: argocd-notifications-controller
    app.kubernetes.io/part-of: argocd
data:
  service.webhook.discord: |
    url: $argocd-sync
    headers:
      - name: Content-Type
        value: application/json

  template.app-sync-succeeded: |
    webhook:
      discord:
        method: POST
        body: |
          {
            "content": ":white_check_mark: **Application {{ .app.metadata.name }} Synced**\n> Synced successfully at `{{ .app.status.operationState.finishedAt }}`."
          }

  template.app-sync-failed: |
    webhook:
      discord:
        method: POST
        body: |
          {
            "content": ":x: **Application {{ .app.metadata.name }} Sync Failed**\n> Error: `{{ .app.status.operationState.message }}`"
          }

  template.app-health-degraded: |
    webhook:
      discord:
        method: POST
        body: |
          {
            "content": ":warning: **Application {{ .app.metadata.name }} Health Degraded**\n> Current status: `{{ .app.status.health.status }}`"
          }

  template.app-deployed: |
    webhook:
      discord:
        method: POST
        body: |
          {
            "content": ":tada: **Application {{ .app.metadata.name }} Deployed**\n> Deployed successfully and healthy at `{{ .app.status.operationState.finishedAt }}`."
          }

  trigger.on-sync-succeeded: |
    - description: Application sync succeeded
      send: [app-sync-succeeded]
      when: app.status.operationState.phase in ['Succeeded']

  trigger.on-sync-failed: |
    - description: Application sync failed
      send: [app-sync-failed]
      when: app.status.operationState.phase in ['Failed', 'Error']

  trigger.on-health-degraded: |
    - description: Application health degraded
      send: [app-health-degraded]
      when: app.status.health.status == 'Degraded'

  trigger.on-deployed: |
    - description: Application deployed and healthy
      send: [app-deployed]
      when: app.status.operationState.phase == 'Succeeded' && app.status.health.status == 'Healthy'

  subscriptions: |
    - recipients:
        - discord
      triggers:
        - on-sync-succeeded
        - on-sync-failed
        - on-health-degraded
        - on-deployed
apiVersion: v1
kind: ConfigMap
metadata:
  name: argocd-notifications-cm
  namespace: argocd
  labels:
    app.kubernetes.io/name: argocd-notifications-controller
    app.kubernetes.io/part-of: argocd
data:
  service.webhook: |
    url: $argocd-notifications-secret:argocd-sync
    method: POST
    headers:
      Content-Type: application/json

  template.app-sync-succeeded: |
    message: |
      Application {{.app.metadata.name}} has been successfully synced.
    webhook:
      url: $argocd-notifications-secret:argocd-sync
      title: "Application {{.app.metadata.name}} Synced"
      description: "Application {{.app.metadata.name}} has been successfully synced at {{.app.status.operationState.finishedAt}}."
      color: "#00ff00"

  template.app-sync-failed: |
    message: |
      Application {{.app.metadata.name}} sync failed.
    webhook:
      url: $argocd-notifications-secret:argocd-sync
      title: "Application {{.app.metadata.name}} Sync Failed"
      description: "Application {{.app.metadata.name}} sync failed. Error: {{.app.status.operationState.message}}"
      color: "#ff0000"

  template.app-health-degraded: |
    message: |
      Application {{.app.metadata.name}} is degraded.
    webhook:
      url: $argocd-notifications-secret:argocd-sync
      title: "Application {{.app.metadata.name}} Degraded"
      description: "Application {{.app.metadata.name}} health is degraded."
      color: "#ff0000"

  template.app-deployed: |
    message: |
      Application {{.app.metadata.name}} has been deployed.
    webhook:
      url: $argocd-notifications-secret:argocd-sync
      title: "Application {{.app.metadata.name}} Deployed"
      description: |
        Application {{.app.metadata.name}} was successfully deployed and is healthy.
      color: "#00ff00"

  trigger.on-sync-failed: |
    - description: Application syncing has failed
      send: [app-sync-failed]
      when: app.status.operationState.phase in ['Failed', 'Error']

  trigger.on-sync-succeeded: |
    - description: Application syncing has succeeded
      send: [app-sync-succeeded]
      when: app.status.operationState.phase in ['Succeeded']

  trigger.on-health-degraded: |
    - description: Application has degraded
      send: [app-health-degraded]
      when: app.status.health.status == 'Degraded'

  trigger.on-deployed: |
    - description: Application deployed and healthy
      send: [app-deployed]
      when: app.status.operationState.phase == 'Succeeded' && app.status.health.status == 'Healthy'

  subscriptions: |
    - recipients:
        - webhook
      triggers:
        - on-sync-succeeded
        - on-sync-failed
        - on-health-degraded
        - on-deployed

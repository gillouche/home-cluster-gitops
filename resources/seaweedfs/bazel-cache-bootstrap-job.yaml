---
apiVersion: batch/v1
kind: Job
metadata:
  name: bazel-cache-bootstrap
  namespace: seaweedfs
  annotations:
    argocd.argoproj.io/sync-wave: "10"
spec:
  backoffLimit: 3
  ttlSecondsAfterFinished: 600
  template:
    spec:
      restartPolicy: OnFailure
      containers:
        - name: bootstrap
          image: amazon/aws-cli:2.15.6
          env:
            # Use Bazel credentials directly (they're configured in SeaweedFS already)
            - name: AWS_ACCESS_KEY_ID
              valueFrom:
                secretKeyRef:
                  name: seaweedfs-access-keys
                  key: bazel_access_key
            - name: AWS_SECRET_ACCESS_KEY
              valueFrom:
                secretKeyRef:
                  name: seaweedfs-access-keys
                  key: bazel_secret_key
            - name: AWS_DEFAULT_REGION
              value: us-east-1
            - name: S3_ENDPOINT
              value: http://seaweedfs-s3.seaweedfs.svc.cluster.local:8333
          command:
            - /bin/sh
            - -c
            - |
              set -e
              
              echo "=== SeaweedFS Bazel Cache Bootstrap ==="
              echo "S3 Endpoint: $S3_ENDPOINT"
              
              # Create bucket (idempotent)
              echo "Creating bazel-cache bucket..."
              aws --endpoint-url=$S3_ENDPOINT \
                s3 mb s3://bazel-cache 2>&1 || echo "Bucket already exists (this is fine)"
              
              # List buckets to verify
              echo "Verifying bucket list..."
              aws --endpoint-url=$S3_ENDPOINT s3 ls
              
              # Try to access the bazel-cache bucket
              echo "Accessing bazel-cache bucket..."
              aws --endpoint-url=$S3_ENDPOINT s3 ls s3://bazel-cache/ || echo "Bucket exists but may be empty"
              
              echo "=== Bootstrap Complete ===" 
              echo "Bucket: bazel-cache created/verified"
              echo "Note: SeaweedFS uses the credentials from seaweedfs-access-keys"

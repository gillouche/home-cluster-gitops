apiVersion: v1
kind: ConfigMap
metadata:
  name: event-exporter-config
  namespace: monitoring
data:
  config.yaml: |
    logLevel: error
    logFormat: json

    route:
      routes:
        - match:
            - type: "Warning"
          receiver: "discord-warning"
        - match:
            - type: "Normal"
          receiver: "discord-info"

    receivers:
      - name: "discord-warning"
        webhook:
          endpoint: "${DISCORD_WARNING_WEBHOOK_URL}"
          headers:
            Content-Type: "application/json"
          layout:
            body: |
              {{- $colors := dict "Normal" 3066993 "Warning" 15158332 "Critical" 15105570 -}}
              {
                "embeds": [
                  {
                    "title": "{{ .Type }} Event in {{ .InvolvedObject.Namespace }}/{{ .InvolvedObject.Kind }}",
                    "description": "{{ .Message }}",
                    "color": {{ index $colors .Type | default 3066993 }},
                    "fields": [
                      {
                        "name": "Reason",
                        "value": "{{ .Reason }}",
                        "inline": true
                      },
                      {
                        "name": "Object",
                        "value": "{{ .InvolvedObject.Name }}",
                        "inline": true
                      },
                      {
                        "name": "Count",
                        "value": "{{ .Count }}",
                        "inline": true
                      }
                    ],
                    "footer": {
                      "text": "{{ .LastTimestamp }}"
                    }
                  }
                ]
              }
      - name: "discord-info"
        webhook:
          endpoint: "${DISCORD_INFO_WEBHOOK_URL}"
          headers:
            Content-Type: "application/json"
          layout:
            body: |
              {{- $colors := dict "Normal" 3066993 "Warning" 15158332 "Critical" 15105570 -}}
              {
                "embeds": [
                  {
                    "title": "{{ .Type }} Event in {{ .InvolvedObject.Namespace }}/{{ .InvolvedObject.Kind }}",
                    "description": "{{ .Message }}",
                    "color": {{ index $colors .Type | default 3066993 }},
                    "fields": [
                      {
                        "name": "Reason",
                        "value": "{{ .Reason }}",
                        "inline": true
                      },
                      {
                        "name": "Object",
                        "value": "{{ .InvolvedObject.Name }}",
                        "inline": true
                      },
                      {
                        "name": "Count",
                        "value": "{{ .Count }}",
                        "inline": true
                      }
                    ],
                    "footer": {
                      "text": "{{ .LastTimestamp }}"
                    }
                  }
                ]
              }
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: event-exporter
  namespace: monitoring
  labels:
    app.kubernetes.io/name: event-exporter
spec:
  replicas: 1
  selector:
    matchLabels:
      app.kubernetes.io/name: event-exporter
  template:
    metadata:
      labels:
        app.kubernetes.io/name: event-exporter
      annotations:
        prometheus.io/scrape: "true"
        prometheus.io/port: "2112"
        prometheus.io/path: "/metrics"
        rollout-restart: "2026-01-11T03:05:00Z"
    spec:
      serviceAccountName: event-exporter
      securityContext:
        runAsNonRoot: true
        seccompProfile:
          type: RuntimeDefault
      containers:
        - name: event-exporter
          image: ghcr.io/resmoio/kubernetes-event-exporter:v1.7
          imagePullPolicy: IfNotPresent
          env:
            - name: DISCORD_WARNING_WEBHOOK_URL
              valueFrom:
                secretKeyRef:
                  name: monitoring-discord-webhooks
                  key: pod-events
            - name: DISCORD_INFO_WEBHOOK_URL
              valueFrom:
                secretKeyRef:
                  name: monitoring-discord-webhooks
                  key: info-alerts
          args:
            - -conf=/data/config.yaml
          ports:
            - name: metrics
              containerPort: 2112
          volumeMounts:
            - name: config
              mountPath: /data
          readinessProbe:
            httpGet:
              path: /metrics
              port: metrics
            initialDelaySeconds: 5
            periodSeconds: 10
          livenessProbe:
            httpGet:
              path: /metrics
              port: metrics
            initialDelaySeconds: 10
            periodSeconds: 20
          securityContext:
            allowPrivilegeEscalation: false
            capabilities:
              drop: ["ALL"]
      volumes:
        - name: config
          configMap:
            name: event-exporter-config
---
apiVersion: v1
kind: Service
metadata:
  name: event-exporter
  namespace: monitoring
spec:
  selector:
    app.kubernetes.io/name: event-exporter
  ports:
    - name: metrics
      port: 2112
      targetPort: metrics
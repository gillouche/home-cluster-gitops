apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: spark-operator
  namespace: argocd
  annotations:
    argocd.argoproj.io/sync-wave: "2"
    notifications.argoproj.io/subscribe.on-sync-failed.webhook.discord-infra: ""
    notifications.argoproj.io/subscribe.on-health-degraded.webhook.discord-infra: ""
  finalizers:
    - argoproj.io/resources-finalizer
spec:
  project: infra-data-lake
  sources:
    - chart: spark-operator
      repoURL: https://kubeflow.github.io/spark-operator
      targetRevision: 2.4.0
      helm:
        values: |
          image:
            tag: 2.4.0
          
          # Global RBAC
          rbac:
            create: true

          # Controller Configuration
          controller:
            # Enable health probe endpoint
            extraArgs:
              - --health-probe-bind-address=:8081
            # Fix for root user in image
            securityContext:
              runAsNonRoot: false
              runAsUser: 0
            # Node Affinity
            affinity:
              nodeAffinity:
                requiredDuringSchedulingIgnoredDuringExecution:
                  nodeSelectorTerms:
                    - matchExpressions:
                        - key: node-class
                          operator: In
                          values: ["homeserver"]
            
          # Webhook Configuration - Disabled due to certificate mounting issues
          # The Helm chart doesn't support custom certificate secrets easily
          # Webhook is optional - controller can manage SparkApplications without it
          webhook:
            enable: false

          # Metrics integration
          metrics:
            enable: true
  destination:
    server: https://kubernetes.default.svc
    namespace: data-lake
  syncPolicy:
    automated:
      prune: true
      selfHeal: true
    syncOptions:
      - CreateNamespace=true
      - ServerSideApply=true

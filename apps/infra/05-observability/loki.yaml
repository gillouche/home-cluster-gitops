apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: loki
  namespace: argocd
  annotations:
    argocd.argoproj.io/sync-wave: "11"
  finalizers:
    - argoproj.io/resources-finalizer
spec:
  project: default
  source:
    chart: loki-stack
    repoURL: https://grafana.github.io/helm-charts
    targetRevision: 2.10.3
    helm:
      values: |
        loki:
          enabled: true
          persistence:
            enabled: true
            storageClassName: longhorn
            size: 10Gi
          affinity:
            nodeAffinity:
              requiredDuringSchedulingIgnoredDuringExecution:
                nodeSelectorTerms:
                  - matchExpressions:
                      - key: node-class
                        operator: In
                        values: ["rpi5"]
                      - key: storage
                        operator: In
                        values: ["ssd", "sdcard"]
                      - key: reliability
                        operator: In
                        values: ["best-effort", "stable"]
          config:
            table_manager:
              retention_deletes_enabled: true
              retention_period: 7d
            ruler:
              storage:
                type: local
                local:
                  directory: /data/loki/rules
              rule_path: /data/loki/rules
              alertmanager_url: http://alertmanager-operated.monitoring.svc:9093
              ring:
                kvstore:
                  store: inmemory
              enable_api: true
          ingress:
            enabled: true
            ingressClassName: traefik
            hosts:
              - host: loki.k3s.gillouche.homelab
                paths:
                  - /
            annotations:
              traefik.ingress.kubernetes.io/router.entrypoints: web

        promtail:
          enabled: true
          # Collects logs from all nodes automatically
          config:
            clients:
              - url: http://{{ .Release.Name }}:3100/loki/api/v1/push
                batchwait: 1s
                batchsize: 102400
            snippets:
              extraScrapeConfigs: |
                - job_name: journal
                  journal:
                    path: /var/log/journal
                    max_age: 12h
                    labels:
                      job: systemd-journal
                  relabel_configs:
                    - source_labels: ['__journal__systemd_unit']
                      target_label: 'unit'
                    - source_labels: ['__journal__hostname']
                      target_label: 'hostname'
          
          # Mount journal directories from host
          extraVolumes:
            - name: journal
              hostPath:
                path: /var/log/journal
            - name: machine-id
              hostPath:
                path: /etc/machine-id
          
          extraVolumeMounts:
            - name: journal
              mountPath: /var/log/journal
              readOnly: true
            - name: machine-id
              mountPath: /etc/machine-id
              readOnly: true

        grafana:
          enabled: false # We use the one from kube-prometheus-stack
  destination:
    server: https://kubernetes.default.svc
    namespace: monitoring
  syncPolicy:
    automated:
      prune: true
      selfHeal: true
    syncOptions:
      - CreateNamespace=true

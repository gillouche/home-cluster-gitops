apiVersion: batch/v1
kind: Job
metadata:
  name: change-sonarqube-admin-password
  namespace: sonarqube
  annotations:
    argocd.argoproj.io/hook: PostSync
    argocd.argoproj.io/hook-delete-policy: HookSucceeded
spec:
  template:
    spec:
      containers:
      - name: change-password
        image: curlimages/curl
        env:
        - name: SONAR_HOST
          value: "http://sonarqube-sonarqube.sonarqube.svc:9000"
        - name: NEW_PASSWORD
          valueFrom:
            secretKeyRef:
              name: sonarqube-admin-creds
              key: password
        command:
        - /bin/sh
        - -c
        - |
          echo "Waiting for SonarQube to be ready..."
          until curl -s "$SONAR_HOST/api/system/status" | grep -q '"status":"UP"'; do
            echo "SonarQube not ready yet..."
            sleep 5
          done
          
          echo "Checking if new password works..."
          # Try connecting with the NEW password
          if curl -u "admin:$NEW_PASSWORD" -f "$SONAR_HOST/api/users/current" > /dev/null 2>&1; then
            echo "Password already set correctly."
            exit 0
          fi
          
          echo "Attempting to change password using default credentials..."
          # Try connecting with default credentials to change it
          http_code=$(curl -s -o /dev/null -w "%{http_code}" -u "admin:admin" -X POST "$SONAR_HOST/api/users/change_password" \
            -d "login=admin" \
            -d "password=$NEW_PASSWORD" \
            -d "previousPassword=admin")
            
          if [ "$http_code" -eq 204 ] || [ "$http_code" -eq 200 ]; then
             echo "Password changed successfully."
             exit 0
          else
             echo "Failed to change password. HTTP Code: $http_code. Maybe default password 'admin' is incorrect or already changed?"
             exit 1
          fi
      restartPolicy: OnFailure
